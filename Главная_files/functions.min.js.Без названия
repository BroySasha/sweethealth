var isMobile = navigator.userAgent.match(/(iPhone|iPod|iPad|BlackBerry|Android)/i) != null;
var mdown = "mousedown";
var mmove = "mousemove";
var mup = "mouseup";
if (isMobile){
    mdown = "touchstart";
    mmove = "touchmove";
    mup = "touchend";
}
var wh;
var ww;
var brand_gutter;
var gall_pos = 0;
var gall_anim = false;
var gall2_ch = 0;
var id1c = "";
var service_iteration = 0;

$(function() {

    //var keys = {37: 1, 38: 1, 39: 1, 40: 1};
    //
    function preventDefault(e) {
        e = e || window.event;
        if (e.preventDefault)
            e.preventDefault();
        e.returnValue = false;
    }



    $(window).resize(function(){
        wh = $(window).height();
        ww = $(window).width();

        //Photo resize - home page
        if(ww > 1000-getScrollbarWidth()) {
            if($('#photos').length > 0){
                photo_k = 1.5;
                for(i=0; i < $('.photo').length; i++){
                    photo_w = Math.floor(($('#photos').width()-32)/2);
                    photo_margin = Math.floor($('#photos').width()/10);
                    if($('.photo').eq(i).hasClass('p1')){
                        $('.photo').eq(i).css('width', photo_w - photo_margin);
                    } else {
                        $('.photo').eq(i).css('width', photo_w);
                    }
                    photo_w = $('.photo').eq(i).width();
                    $('.photo').eq(i).css('height', photo_w / photo_k);
                    $('.photo:nth-child(4n+1)').css('margin-left',photo_margin)
                }
                $('#photos').masonry({
                    itemSelector: '.photo',
                    percentPosition: true,
                    gutter: 32,
                    transitionDuration: 0
                });
            }
        } else {
            photo_k = 1.5;
            $('#photos').attr('style','');

            for(i=0; i < $('.photo').length; i++){
                photo_w = $('.photo').eq(i).width();
                $('.photo').eq(i).css('height', photo_w / photo_k);
            }
        }

        //Brands resize - brands page
        if($('.brands-blocks').length > 0 && !isMobile){
            if(ww > 1376-getScrollbarWidth()){
                brand_gutter = ($('.brands-blocks').width()-3*$('.brand-block').width())/2;
                $('.gutter').css('width', brand_gutter);
                $('.brands-blocks').masonry({
                    itemSelector: '.brand-block',
                    percentPosition: true,
                    gutter: '.gutter',
                    transitionDuration: 0
                });
            } else if(ww <= 1376-getScrollbarWidth()){
                brand_gutter = ($('.brands-blocks').width()-2*$('.brand-block').width());
                $('.gutter').css('width', brand_gutter);
                $('.brands-blocks').masonry({
                    itemSelector: '.brand-block',
                    percentPosition: true,
                    gutter: '.gutter',
                    transitionDuration: 0
                });
            }
        }

        //Contacts blocks max-height - contacts page
        $(".contacts-block").attr('style','');
        max_h = 0;
        setTimeout(function(){
            for (i = 0; i < $(".contacts-block").length; i++){
                if (max_h < $(".contacts-block").eq(i).height()){
                    max_h = $(".contacts-block").eq(i).height();
                }
            }
            $(".contacts-block").css('min-height', max_h);
        },100);

        //Services blocks max-height - home page
        $(".services-cat-info").attr('style','');
        max_sh = 0;
        setTimeout(function(){
            for (i = 0; i < $(".services-cat-info").length; i++){
                if (max_sh < $(".services-cat-info").eq(i).height()){
                    max_sh = $(".services-cat-info").eq(i).height();
                }
            }
            $(".services-cat-info").css('min-height', max_sh);
            if(ww > 1000) {
                $("#services-cats").css('height', max_sh);
            } else {
                $("#services-cats").attr('style','');
            }
        },100);

        //Gallery size - gallery page
        gall_h = wh - ($('#main-title').height() + $('#gallery-nav').height());
        $('#gallery').css('height', gall_h);
        $(".gallery-slide").height($("#gallery").height());

        if(ww > 1000){
            gall_w = $('#gallery').width() - $('#gallery-info').width();
            $('#gallery-slider').css({'width': gall_w, 'height':'100%'});
        } else {
            gall_h = $('#gallery').height() - $('#gallery-info').height();
            $('#gallery-slider').css({'height': gall_h, 'width': '100%'});
        }
        //Gallery 2 - gallery page
        gall_h2 = wh - ($('#main-title').height() + $('#gallery-nav-2').height());
        $('#gallery-2').css('height', gall_h2);
        $(".gallery-slide-2").height($("#gallery-2").height());

        if(ww < 1000){
            gall_hs = wh - ($('#main-title').height() + $('#gallery-nav-2').height()) - $('#gallery-2-nav').height();
            $('#gallery-slider-2').css('height', gall_hs);
            $('#gallery-position-2').css('bottom', $('#gallery-2-nav').height()+32);
        } else {
            $('#gallery-slider-2').attr('style', '');
            $('#gallery-position-2').attr('style','');
        }

        //gall2_w = $('#gallery-slider-2').width();
        //gall_helper = $('.gallery-slide-2').length/2 * gall2_w;
        //$('#gallery-slider-2-helper .gallery-slide-2').css('width',gall2_w);
        //$('#gallery-slider-2-helper').css('margin-left',-gall_helper);

        if ($("#banners").length > 0){
            $(".banner-field").height($("#banners").height() - 220);

        }
        if (isMobile && $("#intro").length>0){
            $("#intro").height($("#content-size").height());
        }
    });
    $(window).resize();

    //Google Map init
    if($('#contacts-map').length > 0){
        initialize($('#contacts-map'),'contacts-map');
    }
    if($('#map-top').length > 0){
        initialize($('#map'),'map');
    }

    //Intro animate - home page
    $(window).scroll(function(e){
        if (!isMobile){
            if($('#intro').hasClass('start') && $('#intro').offset().top > -500){
                $('#intro').addClass('push').removeClass('start');
                window.addEventListener('DOMMouseScroll', preventDefault, false);
                window.onwheel = preventDefault; // modern standard
                window.onmousewheel = document.onmousewheel = preventDefault; // older browsers, IE
                window.ontouchmove  = preventDefault; // mobile
                setTimeout(function(){
                    window.removeEventListener('DOMMouseScroll', preventDefault, false);
                    window.onmousewheel = document.onmousewheel = null;
                    window.onwheel = null;
                    window.ontouchmove = null;
                    document.onkeydown = null;
                },1000);
            }else{
            }
            if($(window).scrollTop() == 0){
                $('#intro').removeClass('push').addClass('start');
            }
            return false;
        }
    });

    //Services slider - home page
    var cat_ind = 0;
    var cat_orient = 0;
    $('.services-cat-li').click(function(){
        //if (cat_ind != $(this).index()) {
        cat_ind = $(this).index();
        $('.services-cat-li, .services-cat-info, .services-cat-img img').removeClass('active');
        $('.services-cat-info').eq(cat_ind).addClass('active');
        $('.services-cat-img img').eq(cat_ind).addClass('active');
        $('.services-cat-li').eq(cat_ind).addClass('active');
        //$('.services-cat-img img.hide').removeClass('hide');
        //$('.services-cat-img img.hideleft').removeClass('hideleft');
        //$(this).addClass('active');
        //$('.services-cat-info').eq(cat_ind).addClass('active');
        //if (cat_orient == 0) {
        //    $('.services-cat-img img').addClass('hide');
        //} else {
        //    $('.services-cat-img img').addClass('hideleft');
        //}
        //$('.services-cat-img img').eq(cat_ind).addClass('active').removeClass("hide hideleft");
        //setTimeout(function () {
        //    $('.services-cat-img img.active.hide').removeClass('hide');
        //    $('.services-cat-img img.active.hideleft').removeClass('hideleft');
        //}, 500);
        //}
    });
    $('.services-next').click(function(){
        cat_ind++;
        cat_orient = 0;
        if (cat_ind == $('.services-cat-li').length){
            cat_ind = 0;
        }
        $('.services-cat-li').eq(cat_ind).click();
    });
    $('.services-prev').click(function(){
        cat_ind--;
        cat_orient = 1;
        if (cat_ind == -1){
            cat_ind = $('.services-cat-li').length-1;
        }
        $('.services-cat-li').eq(cat_ind).click();
    });


    //Tab buttons - about page
    $('.about-tab-btn').click(function(){
        tab_ch = $(this).index();
        $('.about-tab-btn').removeClass('active');
        $(this).addClass('active');
        $('.about-tab').removeClass('active');
        $('.about-tab').eq(tab_ch).addClass('active');
    });
    $(".about-spec").hover(function(){
        if ($(this).find('.about-bubble-text p').text().length > 10){
            $(this).addClass("hover");
        }
    }, function(){
        $(this).removeClass("hover");
    });

    //Accordeon list - service page
    $('.list-section-title').click(function(){
        parent = $(this).parent();
        if(!parent.hasClass('active')){
            parent.addClass('active');
            parent.find('.list-section-ul').slideDown();
        } else {
            parent.removeClass('active');
            parent.find('.list-section-ul').slideUp();
        }
    });

    //Inputs focus - popup window
    $('.modal-input input, .modal-area textarea').focus(function(){
        $(this).parents('.modal-input-wrap').addClass('active');
    });
    $('.modal-input input, .modal-area textarea').focusout(function(){
        $(this).parents('.modal-input-wrap').removeClass('active');
    });

    //Select - popup window
    $('.modal-select-title').click(function(e){
        e.stopPropagation();
        if(!$(this).parents('.modal-input-wrap').hasClass('disabled')){
            if($(this).parents('.modal-input-wrap').hasClass('error')){
                $(this).parents('.modal-input-wrap').removeClass('error');
            }
            if($(this).parent().hasClass('active')){
                $('.modal-select').removeClass('active');
            } else {
                $('.modal-select').removeClass('active');
                $(this).parent().addClass('active');
            }
        }
    });
    $(document).on("click",'.modal-select-li', function(){
        new_val = $(this).html();
        $(this).parents('.modal-select').addClass('selected');
        if (!$(this).parents('.modal-input-wrap').hasClass("services")) {
            $(this).parents('.modal-select').find('.modal-select-title').html(new_val);
            $(this).parents('.modal-input-wrap').find('input').val($(this).data("id"));
        }
        if ($(this).parents('.modal-input-wrap').hasClass("saloon")){
            $(".modal-input-wrap.master").addClass("disabled");
            $(".modal-input-wrap.services").addClass("disabled");
            $('.modal-input-wrap.date').addClass("disabled");
            $('.modal-input-wrap.time').addClass("disabled");
            $('.modal-input-wrap.service').find('.modal-select-title').html("Выберите направление*");
            $('.modal-input-wrap.services').find('.modal-select-title').html("Выберите услугу*");
            $('.modal-input-wrap.master').find('.modal-select-title').html("Выберите мастера*");
            $('.modal-input-wrap.date').find('#order-date').val("");
            $('.modal-input-wrap.time').find('.modal-select-title').html("Время*");
            $(".modal-select-services").html("");
        }
        if ($(this).parents('.modal-input-wrap').hasClass("service")){
            $.get( "order-services-list.php?saloon="+$("#order-saloon").val()+"&service="+$("#order-service").val(), function( data ) {
                $(".modal-input-wrap.services .modal-select-ul-wrap").html( data );
                $(".modal-input-wrap.services").removeClass("disabled error");
                $('.modal-input-wrap.master').removeClass("disabled");
                $('.modal-input-wrap.date').addClass("disabled");
                $('.modal-input-wrap.time').addClass("disabled");
                $('.modal-input-wrap.master').find('.modal-select-title').html("Выберите мастера*");
                $('.modal-input-wrap.services').find('.modal-select-title').html("Выберите услугу*");
                $('.modal-input-wrap.date').find('#order-date').val("");
                $('.modal-input-wrap.time').find('.modal-select-title').html("Время*");
                $(".modal-select-services").html("");
            });
            $.get( "order-master-list.php?saloon="+$("#order-saloon").val()+"&service="+$("#order-service").val(), function( data ) {
                $(".modal-input-wrap.master .modal-select-ul-wrap").html( data );
                $(".modal-input-wrap.master").removeClass("disabled error");
                $('.modal-input-wrap.date').addClass("disabled");
                $('.modal-input-wrap.time').addClass("disabled");
                $('.modal-input-wrap.master').find('.modal-select-title').html("Выберите мастера*");
                $('.modal-input-wrap.date').find('#order-date').val("");
                $('.modal-input-wrap.time').find('.modal-select-title').html("Время*");
            });
        }
        if ($(this).parents('.modal-input-wrap').hasClass("services")){
            $('.modal-input-wrap.services').find('.modal-select-title').html($(this).find("span").html());
            service_iteration = $(this).data('count')*1;
            //$(".modal-select-services").append('<div class="modal-select-service" data-id="'+$(this).data('id')+'"><span>'+$(this).find("span").html()+'</span><div class="select-service-remove"></div></div>');
            //if ($(".modal-select-service").length >= 3){
            //    $('.modal-input-wrap.services').hide();
            //}
            //$(this).hide();
            $(".modal-input-wrap.date").removeClass("disabled");
        }
        if ($(this).parents('.modal-input-wrap').hasClass("master")){
            id1c = $(this).data("id1c");
            $.get( "order-master-list.php?saloon="+$("#order-saloon").val()+"&service="+$("#order-service").val(), function( data ) {
                $(".modal-input-wrap.date").removeClass("disabled error");
                $('.modal-input-wrap.time').addClass("disabled");
                $('.modal-input-wrap.time').find('.modal-select-title').html("Время*");
            });
        }
    });
    $('body').click(function(){
        $('.modal-select').removeClass('active');
    });

    $(document).on("click", ".select-service-remove", function(){
        $('.modal-input-wrap.services').show();
        $('.modal-input-wrap.services').find('.modal-select-li[data-id="'+$(this).parent().data('id')+'"]').show();
        $(this).parent().remove();
    });


    var guid = "";
    $("#order-phone").mask("+7 (999) 999-9999");
    $("#order-but").on("click", function(){
        $(".modal-input-wrap").removeClass("error");
        if ($("#order-name").val() == ""){
            $("#order-name").parents('.modal-input-wrap').addClass("error");
        }
        if ($("#order-phone").val() == ""){
            $("#order-phone").parents('.modal-input-wrap').addClass("error");
        }
        if ($('.modal-input-wrap.service').find('.modal-select-title').html() == "Выберите направление*"){
            $('.modal-input-wrap.service').addClass("error");
        }
        if ($('.modal-input-wrap.master').find('.modal-select-title').html() == "Выберите мастера*"){
            $('.modal-input-wrap.master').addClass("error");
        }
        if ($("#order-date").val() == ""){
            $("#order-date").parents('.modal-input-wrap').addClass("error");
        }
        if ($('.modal-input-wrap.time').find('.modal-select-title').html() == "Время*"){
            $('.modal-input-wrap.time').addClass("error");
        }
        if ($(".modal-input-wrap.error").length == 0){



            //$.get( "getreserve.php?dte="+$("#order-date").val(), function( data ) {
            //    $(".modal-input-wrap.time").removeClass("disabled error");
            //    var xmlelem = $.parseXML(data.return);
            //    json = $.xml2json(xmlelem);
            //    var str = "";
            //    $('.modal-input-wrap.time').find('.modal-select-title').html("Время*");
            //    for (i=0; i< json["#document"]["ГрафикиДляСайта"]["ГрафикДляСайта"].length; i++){
            //        var arr = json["#document"]["ГрафикиДляСайта"]["ГрафикДляСайта"][i];
            //        if (arr["СотрудникID"] == id1c){
            //            str = "";
            //            var arr1 = arr["ПериодыГрафика"]["СвободноеВремя"]["ПериодГрафика"];
            //            if (arr1.length > 0){
            //                for (j=0; j< arr1.length; j++){
            //                    var starttime = arr1[j]["ВремяНачала"].split("T");
            //                    var finishtime = arr1[j]["ВремяОкончания"].split("T");
            //                    starttime = starttime[1].split(":");
            //                    finishtime = finishtime[1].split(":");
            //                    str += '<div class="modal-select-li">'+starttime[0]+':'+starttime[1]+' - '+finishtime[0]+':'+finishtime[1]+'</div>'
            //                }
            //            }
            //            break;
            //        } else {
            //            str = "Свободного времени нет";
            //        }
            //    }
            //    $(".modal-input-wrap.time .modal-select-ul-wrap").html(str);
            //}, "json" );
            //

            //$.post( "getreserve.php", {
            //    name: $("#order-name").val(),
            //    phone: $("#order-phone").val(),
            //    email: $("#order-email").val(),
            //    saloon: $('.modal-input-wrap.saloon').find('.modal-select-title').html(),
            //    service: $('.modal-input-wrap.service').find('.modal-select-title').html(),
            //    master: $('.modal-input-wrap.master').find('.modal-select-title').html(),
            //    masterid: id1c,
            //    date: $("#order-date").val(),
            //    time: $('.modal-input-wrap.time').find('.modal-select-title').html(),
            //    comment: $("#order-comment").val()
            //}, function( data ) {
            //    var xmlelem = $.parseXML(data.return);
            //    json = $.xml2json(xmlelem);
            //    guid = json["#document"]["ОтветНаЗаписьССайта"]["УИД"];

            $.post( "order.php", {
                name: $("#order-name").val(),
                phone: $("#order-phone").val(),
                email: $("#order-email").val(),
                saloon: $('.modal-input-wrap.saloon').find('.modal-select-title').html(),
                service: $('.modal-input-wrap.service').find('.modal-select-title').html(),
                master: $('.modal-input-wrap.master').find('.modal-select-title').html(),
                masterid: id1c,
                iteration: service_iteration,
                //guid: guid,
                date: $("#order-date").val(),
                time: $('.modal-input-wrap.time').find('.modal-select-title').html(),
                comment: $("#order-comment").val()
            }).done(function( data ) {
                $(".order-form").addClass("ordersuccess");
                console.log(data);
            });

            //}, "json");

            //$.post( "getreserve.php", {
            //    name: $("#order-name").val(),
            //    phone: $("#order-phone").val(),
            //    email: $("#order-email").val(),
            //    saloon: $('.modal-input-wrap.saloon').find('.modal-select-title').html(),
            //    service: $('.modal-input-wrap.service').find('.modal-select-title').html(),
            //    master: $('.modal-input-wrap.master').find('.modal-select-title').html(),
            //    masterid: id1c,
            //    date: $("#order-date").val(),
            //    time: $('.modal-input-wrap.time').find('.modal-select-title').html(),
            //    comment: $("#order-comment").val()
            //}).done(function( data ) {
            //$.post( "order.php", {
            //    name: $("#order-name").val(),
            //    phone: $("#order-phone").val(),
            //    email: $("#order-email").val(),
            //    saloon: $('.modal-input-wrap.saloon').find('.modal-select-title').html(),
            //    service: $('.modal-input-wrap.service').find('.modal-select-title').html(),
            //    master: $('.modal-input-wrap.master').find('.modal-select-title').html(),
            //    masterid: id1c,
            //    date: $("#order-date").val(),
            //    time: $('.modal-input-wrap.time').find('.modal-select-title').html(),
            //    comment: $("#order-comment").val()
            //}).done(function( data ) {
            //    $(".order-form").addClass("ordersuccess");
            //});
            //});

        }
        return false;
    });


    // Select scroll init
    if($('.modal-select-ul-wrap').length > 0 && $("#intro").length > 0){
        $('.modal-select-ul-wrap').slimscroll({
            height: 220,
            railVisible: true,
            alwaysVisible: false,
            color: '#d29d5d',
            railColor: '#eee',
            railOpacity: 1,
            size: '3px',
            distance: '32px'
        });

    }
    var date_now = new Date();
    var dnowm = date_now.getMonth()+1;
    if (dnowm < 10){
        dnowm = "0"+dnowm;
    }
    var dnowd = date_now.getDate();
    if (dnowd < 10){
        dnowd = "0"+dnowd;
    }
    var date_next = new Date();
    date_next.setMonth(date_next.getMonth() + 2);
    var dnextm = date_next.getMonth()+1;
    if (dnextm < 10){
        dnextm = "0"+dnextm;
    }
    var dnextd = date_next.getDate();
    if (dnextd < 10){
        dnextd = "0"+dnextd;
    }

    $("#order-date").Zebra_DatePicker({
        direction: [date_now.getFullYear()+"-"+dnowm+"-"+dnowd, date_next.getFullYear()+"-"+dnextm+"-"+dnextd],
        days: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
        months: ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'] ,
        onSelect: function(view, elements) {
            $.get( "order-master-time.php?dte="+$("#order-date").val(), function( data ) {
                $(".modal-input-wrap.time").removeClass("disabled error");
                var xmlelem = $.parseXML(data.return);
                json = $.xml2json(xmlelem);
                var str = "";
                $('.modal-input-wrap.time').find('.modal-select-title').html("Время*");
                for (i=0; i< json["#document"]["ГрафикиДляСайта"]["ГрафикДляСайта"].length; i++){
                    var arr = json["#document"]["ГрафикиДляСайта"]["ГрафикДляСайта"][i];
                    if (arr["СотрудникID"] == id1c){
                        str = "";
                        var arr1 = arr["ПериодыГрафика"]["СвободноеВремя"]["ПериодГрафика"];
                        if (arr1.length > 0){
                            for (j=0; j< arr1.length; j++){
                                var starttime = arr1[j]["ВремяНачала"].split("T");
                                var finishtime = arr1[j]["ВремяОкончания"].split("T");
                                starttime = starttime[1].split(":");
                                finishtime = finishtime[1].split(":");
                                var strt = starttime[0]*60+starttime[1]*1;
                                var fin = finishtime[0]*60+finishtime[1]*1;
                                console.log((fin - service_iteration*15) + " " +strt);
                                if (fin - service_iteration*15 > strt){
                                    var iter = Math.floor((fin - service_iteration*15 - strt)/15);
                                    for (var p=0; p < iter; p++) {
                                        var iterhour = Math.floor(strt / 60);
                                        var itermin = strt - iterhour*60;
                                        if (itermin < 10){
                                            itermin = "0"+itermin;
                                        }
                                        str += '<div class="modal-select-li">'+iterhour+':'+itermin+'</div>';
                                        strt+=15;
                                    }
                                }
                                str += '<div class="modal-select-li">10:00</div>';
                            }
                        }
                        break;
                    } else {
                        str = "Свободного времени нет";
                    }
                }
                $(".modal-input-wrap.time .modal-select-ul-wrap").html(str);
            }, "json" );
        }
    });

    //Open modal window
    $('a[data-action=call-modal]').click(function(e){
        e.preventDefault();
        if (!$('.modal').hasClass('active')){
            modal = $(this).attr('data-modal');
            scroll_pos = $(window).scrollTop();
            all_w = $('#all-content').width();
            $('#all-content').css({top : -scroll_pos, width : all_w}).addClass('fixed').css({"height":"auto"});
            $('#intro').css({width : all_w});
            $('.modal').addClass('active');
            $(".order-form").removeClass("ordersuccess");
            $('.modal-window[data-modal='+ modal +']').addClass('active');
            if(ww <= 768){
                $('#menu').css({width : all_w});
            }
        }
    });

    //Close modal window
    $('.modal-close').click(function(){
        $('.modal').removeClass('active');
        $('.modal-window').removeClass('active');
        setTimeout(function(){
            $('#all-content').removeClass('fixed');
            $('#all-content').attr('style','');
            $('#intro').attr('style','');
            $('#menu').attr('style','');
            $(window).scrollTop(scroll_pos);
        },300);
    });

    //Menu open/close
    $('#header-menu-btn, .burger-btn').click(function(){
        $('#menu').addClass('active');
    });
    $('#close-menu').click(function(){
        $('#menu').removeClass('active');
    });

    //Saloons select open/close
    $('.banner .btn.brown').click(function(){
        $('a[data-action=call-modal]').click();
        return false;
    });
    $('.header-btn.btn.list, .mobile-saloon-btn').click(function(){
        $('#saloons').addClass('active');
        $('.saloon-block').addClass('active');
    });
    $('.saloon-close').click(function(){
        $('#saloons').removeClass('active');
        $('.saloon-block').removeClass('active');
    });



    //Gallery-slider

    $('.gallery-nav-li').click(function(){
        if(!gall_anim){
            gall_anim = true;
            gall_pos = $(this).index();
            $('.gallery-nav-li').removeClass('active');
            $(this).addClass('active');
            $('#gallery-position span').html(gall_pos+1);
            $('#gallery-position-w span').html(gall_pos+1);
            $('.gallery-slide').eq(gall_pos).removeClass('l r');
            $('.gallery-slide:lt('+ gall_pos +')').removeClass('r').addClass('l');
            $('.gallery-slide:gt('+ gall_pos +')').removeClass('l').addClass('r');
            console.log(gall_pos);
            setTimeout(function(){
                gall_anim = false;
            },500);
        }
    });
    $('#gallery-next').click(function(){
        if(!gall_anim) {
            gall_pos++;
            if (gall_pos > $('.gallery-slide').length - 1) {
                gall_pos = 0;
            }
            $('.gallery-nav-li').eq(gall_pos).click();
        }
    });

    //Gallery type 2 - gallery page
    if ($('#gallery-slider-2').length > 0){
        var owl = $('#gallery-slider-2');
        owl.owlCarousel({
            loop: true,
            margin: 0,
            nav: true,
            center: true,
            items: 1
        });
        owl.on('changed.owl.carousel', function(event) {
            gall2_ch = event.item.index-2;
            $('#gallery-position-2 span').html(gall2_ch+1);
            $('.gallery-nav-li-2').removeClass('active');
            $('.gallery-nav-li-2').eq(gall2_ch).addClass('active');
            sliderMin();
        })
    }
    $('#gallery-2-next').click(function() {
        owl.trigger('next.owl.carousel');
        if(gall2_ch < $('.gallery-nav-li-2').length-1){
            gall2_ch++;
        } else {
            gall2_ch = 0;
        }
        $('#gallery-position-2 span').html(gall2_ch+1);
        $('.gallery-nav-li-2').removeClass('active');
        $('.gallery-nav-li-2').eq(gall2_ch).addClass('active');
        sliderMin();
    });
    $('#gallery-2-prev').click(function() {
        owl.trigger('prev.owl.carousel');
        if(gall2_ch > 0){
            gall2_ch--;
        } else {
            gall2_ch = $('.gallery-nav-li-2').length-1;
        }
        $('#gallery-position-2 span').html(gall2_ch+1);
        $('.gallery-nav-li-2').removeClass('active');
        $('.gallery-nav-li-2').eq(gall2_ch).addClass('active');
        sliderMin();
    });
    $('.gallery-nav-li-2').click(function(){
        $('.gallery-nav-li-2').removeClass('active');
        $(this).addClass('active');
        gall2_ch = $(this).index();
        $('.owl-dot').eq(gall2_ch).click();
        $('#gallery-position-2 span').html(gall2_ch+1);
        sliderMin();
    });


    $(".sendmessage").on("click", function(){
        $('.modal').addClass('active');
        $('.modal-window').removeClass('active').hide();
        $('.modal-window.message').addClass('active').show();
        return false;
    });

    $("#brands-page .section-tab-btn").on("click", function(){
        $("#brands-page .section-tab-btn").removeClass('active');
        $(this).addClass('active');
        if ($(this).index() == 0){
            $(".brands-blocks").show();
        }else{
            $(".brands-blocks").hide();
            $(".brands-blocks").eq($(this).index()-1).show();
        }
        return false;
    });


    $("#services-list .section-tab-btn").on("click", function(){
        $("#services-list .section-tab-btn").removeClass('active');
        $(this).addClass('active');
        $(".services-list").removeClass('active');
        $(".services-list").eq($(this).index()).addClass('active').show();
        return false;
    });
    $(".main-place-name span").on("click", function(){
        $('#saloons').addClass('active');
        $('.saloon-block').addClass('active');
        return false;
    });

    //$(".list-cell.c1 span").on("click", function(){
    //    var nm = $(".section-tab-btn.active").index();
    //    $(".modal-input-wrap.service .modal-select-li").eq(nm).click();
    //    $('a[data-action=call-modal]').click();
    //    return false;
    //});


    $(".phone-input").mask("+7 (999) 999-9999");


    $('.sendbut').click(function(e){
        var count = 0;
        var pattern = /^([a-z0-9_\.-])+@[a-z0-9-]+\.([a-z]{2,4}\.)?[a-z]{2,4}$/i;
        $(".modal-form-errors").hide();
        if ($("#form-name").val() == ""){
            $(".modal-form-errors").show();
            $(".modal-form-error").html("Введите имя");
            count++;
        }
        if ($("#form-phone").val() == ""){
            $(".modal-form-errors").show();
            $(".modal-form-error").html("Введите телефон");
            count++;
        }
        if (!pattern.test($("#form-email").val())){
            count++;
            $(".modal-form-errors").show();
            $(".modal-form-error").html("Введите корректный E-mail");
        }

        if (count == 0){
            $.post( "send.php", { name: $("#form-name").val(), phone: $("#form-phone").val(), email: $("input#form-email").val(), theme: $("#form-theme").val(), message: $("#form-message").val()})
                .done(function( data ) {
                    $("#form-name").val("");
                    $("#form-phone").val("");
                    $("#form-email").val("");
                    $("#form-theme").val("");
                    $("#form-message").val("");
                    $('.sendbut').hide();
                    $('.success').addClass('active');
                });
        }
        return false;
    });

    $("#cert-phone").mask("+7 (999) 999-9999");

    $('.sendcert').click(function(e){
        var count = 0;
        var pattern = /^([a-z0-9_\.-])+@[a-z0-9-]+\.([a-z]{2,4}\.)?[a-z]{2,4}$/i;
        $(".modal-form-errors").hide();
        if ($("#cert-name").val() == ""){
            $(".modal-form-errors").show();
            $(".modal-form-error").html("Введите имя");
            count++;
        }
        if ($("#cert-phone").val() == ""){
            $(".modal-form-errors").show();
            $(".modal-form-error").html("Введите телефон");
            count++;
        }
        //if (!pattern.test($("#cert-email").val())){
        //    count++;
        //    $(".modal-form-errors").show();
        //    $(".modal-form-error").html("Введите корректный E-mail");
        //}
        if ($("#cert-sum").val() == ""){
            count++;
            $(".modal-form-errors").show();
            $(".modal-form-error").html("Введите сумму");
        }

        if (count == 0){
            $.post( "certdata.php", { name: $("#cert-name").val(), phone: $("#cert-phone").val(), email: $("#cert-email").val(), sum: $("#cert-sum").val()})
                .done(function( data ) {
                    console.log(data);
                    $("#cert-name").val("");
                    $("#cert-phone").val("");
                    $("#cert-email").val("");
                    $("#cert-sum").val("");
                    $("#cert-form").hide();
                    payCertificate();
                    $("#sbrf").show();
                });
        }
        return false;
    });


    var banner_ch = 0;
    var rot_time = 0;

    $(".banner-dot").on("click", function(){
        $(".banner-dot").removeClass("active");
        $(this).addClass("active");
        $(".banner").removeClass("active");
        banner_ch = $(this).index();
        rot_time = 0;
        $(".banner").eq(banner_ch).addClass("active");
    });

    if ($(".banner").length > 0){
        setInterval(function(){
            rot_time++;
            if (rot_time == 5){
                banner_ch++;
                if (banner_ch == $(".banner").length)  {
                    banner_ch = 0;
                }
                $(".banner-dot").eq(banner_ch).click();
            }
        }, 1000);
    }


    if (isMobile){
        var pos_x = 0;
        var old_pos_x = 0;
        $(".services-cats-top").bind("touchstart",function(event){
            pos_x=event.originalEvent.touches[0].pageX;
            old_pos_x=event.originalEvent.touches[0].pageX;
        });
        $(".services-cats-top").bind("touchmove",function(event){
            pos_x=event.originalEvent.touches[0].pageX;
        });
        $(".services-cats-top").bind("touchend",function(event){
            if (Math.abs(old_pos_x - pos_x) > 50){
                if (old_pos_x < pos_x){
                    $('.services-prev').click();
                }else{
                    $('.services-next').click();
                }
            }
        });
        var ban_pos_x = 0;
        var ban_old_pos_x = 0;
        $("#banners").bind("touchstart",function(event){
            ban_pos_x=event.originalEvent.touches[0].pageX;
            ban_old_pos_x=event.originalEvent.touches[0].pageX;
        });
        $("#banners").bind("touchmove",function(event){
            pos_x=event.originalEvent.touches[0].pageX;
        });
        $("#banners").bind("touchend",function(event){
            if (Math.abs(ban_old_pos_x - pos_x) > 50){
                banner_ch++;
            }else{
                banner_ch--;
            }
            if (banner_ch == -1)  {
                banner_ch =  $(".banner").length-1;
            }
            if (banner_ch == $(".banner").length)  {
                banner_ch = 0;
            }
            $(".banner-dot").eq(banner_ch).click();
        });


        $('.list-info').click(function(e){
            e.stopPropagation();
            $(this).find('.list-tooltip-wrap').show();
        });
        $('body').click(function(e){
            $('.list-tooltip-wrap').hide();
        });



        //.list-info:hover  .list-tooltip-wrap {
        //        display: block;
        //    }

    }

    $(".btn.get-cert").on("click", function(){
        scroll_pos = $(window).scrollTop();
        $('.modal').addClass('active');
        $('.modal-window').removeClass('active').hide();
        $('.modal-window.cert').addClass('active').show();
        return false;
    });

    $(".text-link.delivery").on("click", function(){
        scroll_pos = $(window).scrollTop();
        $('.modal').addClass('active');
        $('.modal-window').removeClass('active').hide();
        $('.modal-window.delivery').addClass('active').show();
        return false;
    });
    $(".text-link.policy").on("click", function(){
        scroll_pos = $(window).scrollTop();
        $('.modal').addClass('active');
        $('.modal-window').removeClass('active').hide();
        $('.modal-window.policy').addClass('active').show();
        return false;
    });

});

function sliderMin(){
    gall_prev = gall2_ch - 1;
    gall_next = gall2_ch + 1;
    if(gall_next > $('.gallery-nav-li-2').length-1){
        gall_next = 0;
    }
    if(gall_next < 0){
        gall_next = $('.gallery-nav-li-2').length-1;
    }
    $('.slider-min.left .slide').eq(gall_prev).removeClass('l r');
    $('.slider-min.left .slide:lt('+ gall_prev +')').removeClass('r').addClass('l');
    $('.slider-min.left .slide:gt('+ gall_prev +')').removeClass('l').addClass('r');
    $('.slider-min.right .slide').eq(gall_next).removeClass('l r');
    $('.slider-min.right .slide:lt('+ gall_next +')').removeClass('r').addClass('l');
    $('.slider-min.right .slide:gt('+ gall_next +')').removeClass('l').addClass('r');
}

function getScrollbarWidth() {
    var outer = document.createElement("div");
    outer.style.visibility = "hidden";
    outer.style.width = "100px";
    document.body.appendChild(outer);

    var widthNoScroll = outer.offsetWidth;
    // force scrollbars
    outer.style.overflow = "scroll";

    // add innerdiv
    var inner = document.createElement("div");
    inner.style.width = "100%";
    outer.appendChild(inner);

    var widthWithScroll = inner.offsetWidth;

    // remove divs
    outer.parentNode.removeChild(outer);

    return widthNoScroll - widthWithScroll;
}

function initialize(id, idname) {
    var styles = [{"featureType":"administrative","elementType":"labels.text.fill","stylers":[{"color":"#444444"}]},{"featureType":"administrative.locality","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"administrative.neighborhood","elementType":"all","stylers":[{"visibility":"on"}]},{"featureType":"landscape","elementType":"all","stylers":[{"color":"#f2f2f2"}]},{"featureType":"poi","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"all","stylers":[{"saturation":-100},{"lightness":45}]},{"featureType":"road.highway","elementType":"all","stylers":[{"visibility":"simplified"}]},{"featureType":"road.arterial","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"all","stylers":[{"color":"#aaced9"},{"visibility":"on"}]}];
    var styledMap = new google.maps.StyledMapType(styles, {name: "Styled Map"});

    var coords = id.data('coord').split(",");
    var coord1 = id.data('coord1').split(",");
    var coord2 = id.data('coord2').split(",");
    var coord3 = id.data('coord3').split(",");
    var scale = id.data('scale');
    var mapOptions = {
        zoom: scale*1,
        scrollwheel: false,
        center: new google.maps.LatLng(coords[0]*1.0005, coords[1]*1),
        disableDefaultUI: true,
        zoomControl: true,
        mapTypeControlOptions: {
            mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style']
        }
    };
    var map = new google.maps.Map(document.getElementById(idname),
        mapOptions);

    map.mapTypes.set('map_style', styledMap);
    map.setMapTypeId('map_style');

    var marker = new google.maps.Marker({
        position: new google.maps.LatLng(coord1[0]*1, coord1[1]*1),
        map: map,
        clickable: true,
        icon: 'images/pointer.png'
    });
    var marker1 = new google.maps.Marker({
        position: new google.maps.LatLng(coord2[0]*1, coord2[1]*1),
        map: map,
        clickable: true,
        icon: 'images/pointer.png'
    });
    var marker2 = new google.maps.Marker({
        position: new google.maps.LatLng(coord3[0]*1, coord3[1]*1),
        map: map,
        clickable: true,
        icon: 'images/pointer.png'
    });

    var contentString = '<div class="map-tip"><div class="map-tip-close"></div><div class="map-tip-content"><div class="map-tip-cover" style="background: url(images/tip.png); background-size: cover;"></div><div class="map-tip-text"><div class="map-tip-title">Prestige Невский</div><p>м. Невский проспект,<br>Невский проспект, д. 40</p><p>+7 (495) 782-80-15</p></div></div></div>';

    var infowindow = new google.maps.InfoWindow({
        content: contentString
    });

    //google.maps.event.addListener(marker, 'click', function() {
    //    infowindow.open(map,marker);
    //});
    //google.maps.event.addListener(marker1, 'click', function() {
    //    infowindow.open(map,marker1);
    //});
    //google.maps.event.addListener(marker2, 'click', function() {
    //    infowindow.open(map,marker2);
    //});




    $(".contacts-block").on("click", function(){
        $(".contacts-block").removeClass("active");
        $(this).addClass("active");
        var coord = $(this).data('coord').split(",");
        var center = new google.maps.LatLng(coord[0]*1.00007, coord[1]*1);
        map.setZoom(14);
        map.panTo(center);
        if ($(window).width() < 500) {
            document.location.href = '//www.google.ru/maps/place/' + $(this).data('coord');
        }
    });
}

function payCertificate() {

    $.post('/sbrf/pay.php', { action : 'pay'}, function (response) {
        $('#sbrf').attr('src', response);
    })
}
